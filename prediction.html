<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriCare Prediction Dashboard</title>
    <!-- Load Chart.js for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Link to your generated CSS file -->
    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar styling for the sidebar for a cleaner look */
        #sidebar::-webkit-scrollbar {
            width: 8px;
        }
        #sidebar::-webkit-scrollbar-thumb {
            background-color: #CBD5E1; /* Slate-300 */
            border-radius: 4px;
        }
        #sidebar::-webkit-scrollbar-track {
            background: transparent;
        }
        /* Style for active button */
        .active-link {
            border-left: 4px solid #10B981; /* agri-green */
            background-color: #ECFDF5; /* Green-50 */
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-agri-light min-h-screen flex flex-col">

    <!-- Header / Navbar -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <span class="bg-agri-green text-white font-bold text-xl px-2 py-1 rounded-full">Ag</span>
                <span class="text-xl font-bold text-gray-800">AgriCare</span>
                <span class="text-sm text-gray-500 hidden md:block">Sustainable Farming • Smart Insights</span>
            </div>
            <div class="flex items-center space-x-4">
                {% if user %}
                <!-- If user is logged in, show profile and name -->
                <div class="flex items-center space-x-3">
                    <span class="font-medium text-gray-700">Welcome, {{ user.fullname }}</span>
                    <img class="w-10 h-10 rounded-full object-cover border-2 border-agri-green" src="{{ url_for('uploaded_file', filename=user.profile_photo_path) }}" alt="Profile Photo">
                    <a href="{{ url_for('logout') }}" class="text-sm text-gray-600 hover:text-agri-green underline">Logout</a>
                </div>
                {% else %}
                <!-- If user is not logged in, show default buttons -->
                <button class="text-gray-600 hover:text-agri-green">मराठी</button>
                <a href="{{ url_for('index') }}" class="bg-agri-green text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-emerald-600 transition">
                    Login
                </a>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-7xl mx-auto w-full p-4 lg:p-6 flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6">

        <!-- Left Sidebar / Slide Bar (Navigation) -->
        <aside id="sidebar" class="w-full lg:w-72 bg-agri-card rounded-xl shadow-lg p-4 h-full lg:sticky lg:top-20 overflow-y-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Prediction Tools</h2>

            <nav class="space-y-2">
                <!-- Predict Weather Link (Active by default) -->
                <button
                    id="link-weather"
                    data-target="weather-content"
                    class="nav-link w-full text-left p-3 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150 active-link"
                    onclick="switchContent(this)"
                >
                    <div class="flex items-center space-x-3">
                        <svg class="w-6 h-6 text-agri-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg>
                        <span class="font-medium">Predict Weather</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 pl-9">Short-term forecasts tailored to your field.</p>
                </button>

                <!-- Predict Crop Link -->
                <button
                    id="link-crop"
                    data-target="crop-content"
                    class="nav-link w-full text-left p-3 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150"
                    onclick="switchContent(this)"
                >
                    <div class="flex items-center space-x-3">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l2-2l2 2v13"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21v-2"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 10v4h4v-4h-4z"></path></svg>
                        <span class="font-medium">Predict Crop</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 pl-9">AI suggestions for best-fit crops based on soil and history.</p>
                </button>

                <!-- Predict Seed Rate Link -->
                <button
                    id="link-seed"
                    data-target="seed-content"
                    class="nav-link w-full text-left p-3 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150"
                    onclick="switchContent(this)"
                >
                    <div class="flex items-center space-x-3">
                        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3 .895-3 2 1.343 2 3 2m-3 0h6"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="font-medium">Predict Seed Rate</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 pl-9">Accurate estimates to optimize input costs.</p>
                </button>
            </nav>
        </aside>

        <!-- Right Content Area (Dynamic Display) -->
        <section class="flex-grow">
            <div id="content-container" class="space-y-6">

                <!-- 1. Predict Weather Content -->
                <div id="weather-content" class="content-card bg-agri-card p-6 rounded-xl shadow-lg border border-gray-100">
                    <h1 class="text-3xl font-bold text-agri-green mb-4">Live Weather Forecast</h1>
                    <p class="text-gray-600 mb-6">Get 7-day hyper-local weather predictions for your farm location, including temperature, humidity, and rainfall probability.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="location" class="block text-sm font-medium text-gray-700">Select Location / Coordinates</label>
                            <input type="text" id="location" value="Manwath, Parbhani, Maharashtra, India" placeholder="e.g., Maharashtra, India" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-agri-green focus:ring focus:ring-agri-green focus:ring-opacity-50">
                        </div>
                        <div class="flex items-end">
                            <button id="get-forecast-btn" class="bg-agri-green text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-emerald-600 transition w-full">Get Forecast</button>
                        </div>
                    </div>

                    <!-- Main Forecast Display Area -->
                    <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left side: Bar Graph -->
                        <div class="lg:col-span-2">
                            <canvas id="weatherChart"></canvas>
                        </div>


                        <!-- Right side: Current Conditions & Tips -->
                        <div id="current-conditions-panel" class="bg-gray-50 p-4 rounded-lg border hidden">
                            <h3 class="font-bold text-lg mb-2">Current Conditions</h3>
                            <p id="current-location" class="text-sm text-gray-500 mb-4"></p>
                            <div class="space-y-3 text-gray-700">
                                <p><strong>Temperature:</strong> <span id="current-temp"></span></p>
                                <p><strong>Humidity:</strong> <span id="current-humidity"></span></p>
                                <p><strong>Precipitation:</strong> <span id="current-precip"></span></p>
                                <p><strong>Wind:</strong> <span id="current-wind"></span></p>
                            </div>
                            <hr class="my-4">
                            <h3 class="font-bold text-lg mb-2">Weather Tips</h3>
                            <ul id="weather-tips-list" class="list-disc list-inside space-y-2 text-sm text-gray-600"></ul>
                        </div>
                    </div>

                    <!-- Hourly Forecast Display Area -->
                    <div class="mt-8">
                        <h3 class="font-bold text-xl mb-2 text-center">Today (Hourly)</h3>
                        <canvas id="hourlyWeatherChart"></canvas>
                    </div>
                </div>
                <!-- 2. Predict Crop Content (Initially Hidden) -->
                <div id="crop-content" class="content-card bg-agri-card p-6 rounded-xl shadow-lg border border-gray-100 hidden">
                    <h1 class="text-3xl font-bold text-yellow-700 mb-4">Optimal Crop Recommendation</h1>
                    <p class="text-gray-600 mb-6">Enter your soil data and historical parameters to get a personalized crop suggestion that maximizes yield.</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label for="nitrogen" class="block text-sm font-medium text-gray-700">Nitrogen (N) level (ppm)</label>
                            <input type="number" id="nitrogen" placeholder="e.g., 90" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-agri-green focus:ring focus:ring-agri-green focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="phos" class="block text-sm font-medium text-gray-700">Phosphorus (P) level (ppm)</label>
                            <input type="number" id="phos" placeholder="e.g., 42" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-agri-green focus:ring focus:ring-agri-green focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="soil_ph" class="block text-sm font-medium text-gray-700">Soil pH</label>
                            <input type="number" id="soil_ph" placeholder="e.g., 6.5" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-agri-green focus:ring focus:ring-agri-green focus:ring-opacity-50">
                        </div>
                    </div>

                    <button class="bg-yellow-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-yellow-700 transition">Analyze & Recommend</button>

                    <div class="mt-8 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-md">
                        <p class="font-semibold text-yellow-800">Recommendation:</p>
                        <p class="text-yellow-700 text-sm">Based on the high NPK ratio and slightly acidic pH, the AI strongly recommends growing **Cotton** or **Maize** this season.</p>
                    </div>
                </div>

                <!-- 3. Predict Seed Rate Content (Initially Hidden) -->
                <div id="seed-content" class="content-card bg-agri-card p-6 rounded-xl shadow-lg border border-gray-100 hidden">
                    <h1 class="text-3xl font-bold text-indigo-700 mb-4">Dynamic Seed Rate Calculator</h1>
                    <p class="text-gray-600 mb-6">Calculate the precise seed quantity needed based on field size, crop type, and desired plant density to reduce waste.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="area" class="block text-sm font-medium text-gray-700">Field Area (Acres)</label>
                            <input type="number" id="area" placeholder="e.g., 5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-agri-green focus:ring focus:ring-agri-green focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="crop_type" class="block text-sm font-medium text-gray-700">Crop Type</label>
                            <select id="crop_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-agri-green focus:ring focus:ring-agri-green focus:ring-opacity-50">
                                <option>Wheat</option>
                                <option>Rice</option>
                                <option>Maize</option>
                                <option>Cotton</option>
                            </select>
                        </div>
                        <div>
                            <label for="density" class="block text-sm font-medium text-gray-700">Target Density (plants/sq. meter)</label>
                            <input type="number" id="density" placeholder="e.g., 25" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-agri-green focus:ring focus:ring-agri-green focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="germination" class="block text-sm font-medium text-gray-700">Seed Germination Rate (%)</label>
                            <input type="number" id="germination" placeholder="e.g., 90" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-agri-green focus:ring focus:ring-agri-green focus:ring-opacity-50">
                        </div>
                    </div>

                    <button class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition">Calculate Seed Rate</button>

                    <div class="mt-8 p-4 bg-indigo-50 border-l-4 border-indigo-400 rounded-md">
                        <p class="font-semibold text-indigo-800">Required Seed Rate:</p>
                        <p class="text-indigo-700 text-sm">For 5 acres of Wheat with 90% germination, you need approximately **120 kg** of seeds.</p>
                    </div>
                </div>

            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="mt-8 p-4 bg-white border-t">
        <div class="max-w-7xl mx-auto text-center text-sm text-gray-500">
            &copy; 2025 AgriCare • Built for farmers
        </div>
    </footer>

    <script>
        let weatherChartInstance = null; // To hold the chart object
        let hourlyChartInstance = null; // To hold the hourly chart object
        /**
         * Function to switch the visible content based on the clicked navigation link.
         * @param {HTMLElement} clickedElement - The button element that was clicked.
         */
        function switchContent(clickedElement) {
            const targetId = clickedElement.getAttribute('data-target');
            const contentCards = document.querySelectorAll('.content-card');
            const navLinks = document.querySelectorAll('.nav-link');

            // 1. Hide all content cards
            contentCards.forEach(card => {
                card.classList.add('hidden');
            });

            // 2. Remove 'active' styling from all links
            navLinks.forEach(link => {
                link.classList.remove('active-link');
            });

            // 3. Show the target content card
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
                targetContent.classList.remove('hidden');
                targetContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // 4. Add 'active' styling to the clicked link
            clickedElement.classList.add('active-link');
        }

        /**
         * Fetches weather data and draws the chart.
         */
        async function fetchAndDrawWeatherChart() {
            const forecastBtn = document.getElementById('get-forecast-btn');
            forecastBtn.textContent = 'Loading...';
            forecastBtn.disabled = true;

            try {
                const locationInput = document.getElementById('location');
                const location = locationInput.value || locationInput.placeholder; // Use input value or placeholder

                // Send the location as a query parameter to the backend
                const response = await fetch(`/weather-forecast?location=${encodeURIComponent(location)}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();

                // 1. Populate Current Conditions Panel
                document.getElementById('current-location').textContent = data.location;
                document.getElementById('current-temp').textContent = `${data.current.temp} °C`;
                document.getElementById('current-humidity').textContent = `${data.current.humidity} %`;
                document.getElementById('current-precip').textContent = `${data.current.precipitation} mm`;
                document.getElementById('current-wind').textContent = `${data.current.wind} m/s`;
                
                const tipsList = document.getElementById('weather-tips-list');
                tipsList.innerHTML = ''; // Clear old tips
                data.tips.forEach(tip => {
                    const li = document.createElement('li');
                    li.textContent = tip;
                    tipsList.appendChild(li);
                });
                document.getElementById('current-conditions-panel').classList.remove('hidden');

                // 2. Draw the 7-Day Bar Chart
                const dailyLabels = data.daily.map(d => d.day_name);
                const maxTemps = data.daily.map(d => d.max_temp);
                const minTemps = data.daily.map(d => d.min_temp);
                const ctx = document.getElementById('weatherChart').getContext('2d');

                if (weatherChartInstance) {
                    weatherChartInstance.destroy();
                }

                weatherChartInstance = new Chart(ctx, {
                    type: 'bar', // Changed to bar chart
                    data: {
                        labels: dailyLabels,
                        datasets: [{
                            label: 'Max Temperature (°C)',
                            data: maxTemps,
                            backgroundColor: 'rgba(239, 68, 68, 0.6)', // Red-500 with opacity
                            borderColor: '#EF4444',
                            borderWidth: 1
                        }, {
                            label: 'Min Temperature (°C)',
                            data: minTemps,
                            backgroundColor: 'rgba(59, 130, 246, 0.6)', // Blue-500 with opacity
                            borderColor: '#3B82F6',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: '7-Day Temperature Forecast',
                                font: { size: 16 }
                            }
                        }
                    }
                });

                // 3. Draw the Hourly Line Chart
                const hourlyLabels = data.hourly.map(h => h.hour);
                const hourlyTemps = data.hourly.map(h => h.temp);
                const hourlyCtx = document.getElementById('hourlyWeatherChart').getContext('2d');

                if (hourlyChartInstance) {
                    hourlyChartInstance.destroy();
                }

                hourlyChartInstance = new Chart(hourlyCtx, {
                    type: 'line',
                    data: {
                        labels: hourlyLabels,
                        datasets: [{
                            label: 'Temperature (°C)',
                            data: hourlyTemps,
                            borderColor: '#10B981', // agri-green
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false // Hide legend for a cleaner look
                            },
                            title: {
                                display: true,
                                text: 'Hourly Temperature Trend'
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    autoSkip: true,
                                    maxTicksLimit: 12 // Show fewer labels on x-axis
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Failed to fetch weather forecast:', error);
                alert(`Could not fetch weather: ${error.message}`);
            } finally {
                forecastBtn.textContent = 'Get Forecast';
                forecastBtn.disabled = false;
            }
        }

        // Attach event listener to the forecast button
        document.getElementById('get-forecast-btn').addEventListener('click', fetchAndDrawWeatherChart);
    </script>
</body>
</html>